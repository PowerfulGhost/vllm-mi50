#pragma once

#include <array>
#include <tuple>
#include <unordered_map>
#include <optional>   // std::optional
#include <functional> // std::hash

using LookupKey = std::tuple<int, int, int>;
using LookupValue = std::array<int, 5>;

struct TupleHash
{
    template <class T1, class T2, class T3>
    std::size_t operator()(const std::tuple<T1, T2, T3> &t) const
    {
        auto [x, y, z] = t;
        return std::hash<T1>()(x) ^ (std::hash<T2>()(y) << 1) ^ (std::hash<T3>()(z) << 2);
    }
};

inline std::unordered_map<LookupKey, LookupValue, TupleHash> size_lookup_table = {
    {{1280, 10, 5120}, {8, 10, 16, 4, 5}},   // time(us): 58.4
    {{1280, 11, 5120}, {8, 11, 8, 4, 11}},   // time(us): 67.04
    {{1280, 12, 5120}, {16, 4, 8, 16, 4}},   // time(us): 58.24
    {{1280, 13, 5120}, {8, 13, 8, 4, 13}},   // time(us): 71.84
    {{1280, 14, 5120}, {16, 7, 8, 8, 7}},    // time(us): 72.48
    {{1280, 15, 5120}, {16, 5, 8, 8, 5}},    // time(us): 69.12
    {{1280, 16, 5120}, {8, 8, 4, 8, 8}},     // time(us): 76.16
    {{1280, 1, 5120}, {8, 1, 64, 8, 1}},     // time(us): 25.76
    {{1280, 2, 5120}, {8, 2, 32, 8, 2}},     // time(us): 25.44
    {{1280, 3, 5120}, {8, 3, 32, 4, 3}},     // time(us): 31.52
    {{1280, 4, 5120}, {8, 4, 32, 4, 4}},     // time(us): 31.36
    {{1280, 5, 5120}, {8, 5, 32, 2, 5}},     // time(us): 38.24
    {{1280, 6, 5120}, {16, 3, 16, 8, 3}},    // time(us): 40.64
    {{1280, 7, 5120}, {8, 7, 16, 4, 7}},     // time(us): 50.56
    {{1280, 8, 5120}, {8, 4, 16, 4, 4}},     // time(us): 46.08
    {{1280, 9, 5120}, {8, 9, 8, 8, 9}},      // time(us): 54.24
    {{128, 10, 5120}, {8, 2, 64, 8, 2}},     // time(us): 18.56
    {{128, 10, 896}, {16, 2, 32, 16, 2}},    // time(us): 11.36
    {{128, 11, 5120}, {8, 1, 64, 8, 1}},     // time(us): 24.48
    {{128, 11, 896}, {8, 1, 32, 8, 1}},      // time(us): 12.64
    {{128, 12, 5120}, {4, 4, 64, 4, 4}},     // time(us): 18.88
    {{128, 12, 896}, {8, 4, 32, 8, 4}},      // time(us): 10.88
    {{128, 13, 5120}, {4, 1, 32, 4, 1}},     // time(us): 27.2
    {{128, 13, 896}, {16, 1, 16, 16, 1}},    // time(us): 13.44
    {{128, 14, 5120}, {8, 2, 64, 8, 2}},     // time(us): 19.68
    {{128, 14, 896}, {8, 2, 32, 8, 2}},      // time(us): 12.48
    {{128, 15, 5120}, {8, 3, 64, 4, 3}},     // time(us): 23.36
    {{128, 15, 896}, {16, 1, 32, 16, 1}},    // time(us): 12.16
    {{128, 16, 5120}, {8, 4, 32, 8, 4}},     // time(us): 21.6
    {{128, 16, 896}, {8, 8, 16, 8, 8}},      // time(us): 12.16
    {{128, 1, 5120}, {4, 1, 64, 4, 1}},      // time(us): 15.2
    {{128, 1, 896}, {8, 1, 32, 8, 1}},       // time(us): 11.36
    {{128, 2, 5120}, {2, 2, 64, 2, 2}},      // time(us): 15.2
    {{128, 2, 896}, {4, 2, 32, 4, 2}},       // time(us): 10.72
    {{128, 3, 5120}, {8, 1, 64, 8, 1}},      // time(us): 16.48
    {{128, 3, 896}, {4, 3, 32, 4, 3}},       // time(us): 10.72
    {{128, 4, 5120}, {8, 2, 64, 8, 2}},      // time(us): 16.64
    {{128, 4, 896}, {4, 4, 32, 4, 4}},       // time(us): 10.72
    {{128, 5, 5120}, {4, 1, 64, 4, 1}},      // time(us): 18.4
    {{128, 5, 896}, {4, 5, 32, 4, 5}},       // time(us): 11.2
    {{128, 6, 5120}, {8, 2, 64, 8, 2}},      // time(us): 16.96
    {{128, 6, 896}, {16, 1, 32, 16, 1}},     // time(us): 10.56
    {{128, 7, 5120}, {8, 1, 64, 8, 1}},      // time(us): 20.32
    {{128, 7, 896}, {16, 1, 32, 16, 1}},     // time(us): 11.68
    {{128, 8, 5120}, {8, 2, 64, 8, 2}},      // time(us): 19.04
    {{128, 8, 896}, {16, 2, 32, 16, 2}},     // time(us): 11.2
    {{128, 9, 5120}, {2, 3, 64, 2, 3}},      // time(us): 20.64
    {{128, 9, 896}, {4, 3, 32, 4, 3}},       // time(us): 11.84
    {{256, 10, 5120}, {8, 2, 32, 8, 2}},     // time(us): 24.32
    {{256, 11, 5120}, {4, 11, 16, 4, 11}},   // time(us): 32.16
    {{256, 12, 5120}, {4, 4, 32, 4, 4}},     // time(us): 24.16
    {{256, 13, 5120}, {4, 13, 16, 4, 13}},   // time(us): 35.36
    {{256, 14, 5120}, {16, 2, 32, 16, 2}},   // time(us): 25.6
    {{256, 15, 5120}, {8, 3, 32, 4, 3}},     // time(us): 28.32
    {{256, 16, 5120}, {8, 4, 32, 4, 4}},     // time(us): 29.92
    {{256, 1, 5120}, {4, 1, 64, 4, 1}},      // time(us): 17.12
    {{256, 2, 5120}, {2, 2, 64, 2, 2}},      // time(us): 17.28
    {{256, 3, 5120}, {2, 3, 64, 2, 3}},      // time(us): 18.56
    {{256, 4, 5120}, {8, 2, 64, 8, 2}},      // time(us): 18.4
    {{256, 5, 5120}, {2, 5, 64, 1, 5}},      // time(us): 23.68
    {{256, 6, 5120}, {8, 2, 64, 8, 2}},      // time(us): 19.2
    {{256, 7, 5120}, {4, 7, 32, 4, 7}},      // time(us): 26.56
    {{256, 8, 5120}, {8, 4, 32, 8, 4}},      // time(us): 22.24
    {{256, 9, 5120}, {8, 3, 32, 8, 3}},      // time(us): 24.32
    {{3456, 10, 5120}, {16, 10, 4, 8, 10}},  // time(us): 114.56
    {{3456, 11, 5120}, {32, 11, 4, 16, 11}}, // time(us): 127.04
    {{3456, 12, 5120}, {16, 6, 4, 8, 6}},    // time(us): 126.08
    {{3456, 13, 5120}, {8, 13, 4, 8, 13}},   // time(us): 148.16
    {{3456, 14, 5120}, {16, 14, 2, 16, 14}}, // time(us): 146.4
    {{3456, 15, 5120}, {8, 15, 4, 8, 15}},   // time(us): 156.0
    {{3456, 16, 5120}, {12, 8, 8, 4, 4}},    // time(us): 151.04
    {{3456, 1, 5120}, {32, 1, 16, 32, 1}},   // time(us): 42.4
    {{3456, 2, 5120}, {12, 2, 16, 6, 2}},    // time(us): 43.04
    {{3456, 3, 5120}, {12, 3, 16, 4, 3}},    // time(us): 50.4
    {{3456, 4, 5120}, {6, 4, 16, 2, 4}},     // time(us): 58.4
    {{3456, 5, 5120}, {16, 5, 8, 8, 5}},     // time(us): 71.2
    {{3456, 6, 5120}, {8, 6, 8, 4, 6}},      // time(us): 77.12
    {{3456, 7, 5120}, {16, 7, 4, 16, 7}},    // time(us): 86.72
    {{3456, 8, 5120}, {16, 8, 4, 16, 8}},    // time(us): 86.72
    {{3456, 9, 5120}, {16, 9, 4, 8, 9}},     // time(us): 113.44
    {{4864, 10, 896}, {32, 5, 2, 16, 5}},    // time(us): 39.2
    {{4864, 11, 896}, {32, 11, 2, 16, 11}},  // time(us): 41.92
    {{4864, 12, 896}, {64, 4, 2, 64, 4}},    // time(us): 36.64
    {{4864, 13, 896}, {32, 13, 2, 16, 13}},  // time(us): 45.28
    {{4864, 14, 896}, {16, 7, 2, 8, 7}},     // time(us): 41.28
    {{4864, 15, 896}, {64, 5, 2, 32, 5}},    // time(us): 43.68
    {{4864, 16, 896}, {16, 8, 2, 8, 8}},     // time(us): 43.84
    {{4864, 1, 896}, {8, 1, 16, 4, 1}},      // time(us): 20.16
    {{4864, 2, 896}, {32, 2, 16, 16, 2}},    // time(us): 20.0
    {{4864, 3, 896}, {32, 3, 8, 16, 3}},     // time(us): 23.36
    {{4864, 4, 896}, {16, 4, 4, 16, 4}},     // time(us): 22.56
    {{4864, 5, 896}, {32, 5, 4, 16, 5}},     // time(us): 27.52
    {{4864, 6, 896}, {16, 6, 4, 8, 6}},      // time(us): 27.36
    {{4864, 7, 896}, {32, 7, 4, 16, 7}},     // time(us): 29.28
    {{4864, 8, 896}, {8, 8, 4, 4, 8}},       // time(us): 29.44
    {{4864, 9, 896}, {64, 3, 2, 64, 3}},     // time(us): 35.2
    {{5120, 10, 1280}, {32, 5, 4, 8, 5}},    // time(us): 52.64
    {{5120, 10, 3456}, {32, 5, 4, 8, 5}},    // time(us): 122.08
    {{5120, 10, 640}, {16, 10, 2, 8, 10}},   // time(us): 31.68
    {{5120, 10, 6912}, {32, 5, 4, 8, 5}},    // time(us): 236.0
    {{5120, 11, 1280}, {16, 11, 2, 8, 11}},  // time(us): 54.88
    {{5120, 11, 3456}, {16, 11, 2, 8, 11}},  // time(us): 127.36
    {{5120, 11, 640}, {32, 11, 2, 16, 11}},  // time(us): 33.6
    {{5120, 11, 6912}, {16, 11, 2, 8, 11}},  // time(us): 244.96
    {{5120, 12, 1280}, {64, 4, 2, 64, 4}},   // time(us): 49.44
    {{5120, 12, 3456}, {64, 4, 2, 64, 4}},   // time(us): 114.88
    {{5120, 12, 640}, {64, 4, 2, 64, 4}},    // time(us): 29.76
    {{5120, 12, 6912}, {64, 4, 2, 64, 4}},   // time(us): 230.72
    {{5120, 13, 1280}, {32, 13, 2, 16, 13}}, // time(us): 60.8
    {{5120, 13, 3456}, {32, 13, 2, 16, 13}}, // time(us): 144.48
    {{5120, 13, 640}, {32, 13, 2, 16, 13}},  // time(us): 36.48
    {{5120, 13, 6912}, {32, 13, 2, 16, 13}}, // time(us): 276.8
    {{5120, 14, 1280}, {16, 7, 2, 8, 7}},    // time(us): 55.2
    {{5120, 14, 3456}, {16, 7, 2, 8, 7}},    // time(us): 131.52
    {{5120, 14, 640}, {16, 7, 2, 8, 7}},     // time(us): 32.8
    {{5120, 14, 6912}, {16, 7, 2, 8, 7}},    // time(us): 257.76
    {{5120, 15, 1280}, {64, 5, 2, 32, 5}},   // time(us): 59.68
    {{5120, 15, 3456}, {64, 5, 2, 32, 5}},   // time(us): 136.48
    {{5120, 15, 640}, {64, 5, 2, 32, 5}},    // time(us): 35.04
    {{5120, 15, 6912}, {64, 5, 2, 32, 5}},   // time(us): 270.88
    {{5120, 16, 1280}, {16, 8, 2, 8, 8}},    // time(us): 57.28
    {{5120, 16, 3456}, {16, 8, 2, 8, 8}},    // time(us): 139.52
    {{5120, 16, 640}, {16, 8, 2, 8, 8}},     // time(us): 34.24
    {{5120, 16, 6912}, {16, 8, 2, 8, 8}},    // time(us): 275.04
    {{5120, 1, 1280}, {8, 1, 16, 4, 1}},     // time(us): 24.8
    {{5120, 1, 3456}, {32, 1, 16, 32, 1}},   // time(us): 43.2
    {{5120, 1, 640}, {8, 1, 8, 8, 1}},       // time(us): 18.24
    {{5120, 1, 6912}, {32, 1, 16, 16, 1}},   // time(us): 72.8
    {{5120, 2, 1280}, {16, 2, 8, 16, 2}},    // time(us): 22.72
    {{5120, 2, 3456}, {16, 2, 16, 8, 2}},    // time(us): 42.72
    {{5120, 2, 640}, {32, 2, 8, 32, 2}},     // time(us): 17.76
    {{5120, 2, 6912}, {16, 2, 16, 8, 2}},    // time(us): 76.0
    {{5120, 3, 1280}, {16, 3, 8, 8, 3}},     // time(us): 25.76
    {{5120, 3, 3456}, {16, 3, 16, 4, 3}},    // time(us): 48.32
    {{5120, 3, 640}, {32, 3, 8, 16, 3}},     // time(us): 20.16
    {{5120, 3, 6912}, {16, 3, 16, 4, 3}},    // time(us): 85.76
    {{5120, 4, 1280}, {8, 4, 8, 4, 4}},      // time(us): 26.88
    {{5120, 4, 3456}, {32, 4, 8, 16, 4}},    // time(us): 55.68
    {{5120, 4, 640}, {32, 4, 8, 16, 4}},     // time(us): 19.04
    {{5120, 4, 6912}, {8, 4, 8, 4, 4}},      // time(us): 99.68
    {{5120, 5, 1280}, {8, 5, 4, 4, 5}},      // time(us): 34.08
    {{5120, 5, 3456}, {8, 5, 4, 4, 5}},      // time(us): 74.72
    {{5120, 5, 640}, {32, 5, 4, 16, 5}},     // time(us): 23.52
    {{5120, 5, 6912}, {16, 5, 4, 8, 5}},     // time(us): 137.44
    {{5120, 6, 1280}, {32, 3, 8, 8, 3}},     // time(us): 35.84
    {{5120, 6, 3456}, {16, 6, 4, 8, 6}},     // time(us): 76.96
    {{5120, 6, 640}, {16, 6, 4, 8, 6}},      // time(us): 22.88
    {{5120, 6, 6912}, {16, 6, 4, 8, 6}},     // time(us): 140.64
    {{5120, 7, 1280}, {16, 7, 4, 8, 7}},     // time(us): 38.08
    {{5120, 7, 3456}, {8, 7, 4, 4, 7}},      // time(us): 80.32
    {{5120, 7, 640}, {32, 7, 4, 16, 7}},     // time(us): 25.12
    {{5120, 7, 6912}, {8, 7, 4, 4, 7}},      // time(us): 148.16
    {{5120, 8, 1280}, {8, 8, 4, 4, 8}},      // time(us): 38.08
    {{5120, 8, 3456}, {8, 8, 4, 4, 8}},      // time(us): 83.68
    {{5120, 8, 640}, {16, 8, 4, 8, 8}},      // time(us): 24.32
    {{5120, 8, 6912}, {8, 8, 4, 4, 8}},      // time(us): 157.28
    {{5120, 9, 1280}, {32, 9, 2, 32, 9}},    // time(us): 45.92
    {{5120, 9, 3456}, {64, 3, 2, 64, 3}},    // time(us): 104.32
    {{5120, 9, 640}, {32, 3, 2, 32, 3}},     // time(us): 28.48
    {{5120, 9, 6912}, {32, 9, 2, 32, 9}},    // time(us): 192.96
    {{640, 10, 5120}, {4, 10, 32, 2, 5}},    // time(us): 37.44
    {{640, 11, 5120}, {4, 11, 16, 2, 11}},   // time(us): 46.4
    {{640, 12, 5120}, {8, 4, 16, 8, 4}},     // time(us): 32.96
    {{640, 13, 5120}, {4, 13, 16, 2, 13}},   // time(us): 53.92
    {{640, 14, 5120}, {8, 7, 16, 4, 7}},     // time(us): 42.88
    {{640, 15, 5120}, {8, 5, 16, 4, 5}},     // time(us): 42.88
    {{640, 16, 5120}, {8, 4, 16, 4, 4}},     // time(us): 45.92
    {{640, 1, 5120}, {4, 1, 64, 4, 1}},      // time(us): 19.52
    {{640, 2, 5120}, {4, 2, 64, 4, 2}},      // time(us): 20.96
    {{640, 3, 5120}, {4, 3, 32, 4, 3}},      // time(us): 24.48
    {{640, 4, 5120}, {16, 2, 32, 16, 2}},    // time(us): 24.96
    {{640, 5, 5120}, {4, 5, 32, 2, 5}},      // time(us): 29.44
    {{640, 6, 5120}, {16, 2, 32, 16, 2}},    // time(us): 27.84
    {{640, 7, 5120}, {4, 7, 16, 4, 7}},      // time(us): 35.36
    {{640, 8, 5120}, {8, 4, 32, 4, 4}},      // time(us): 30.4
    {{640, 9, 5120}, {8, 3, 16, 8, 3}},      // time(us): 34.56
    {{6912, 10, 5120}, {48, 5, 4, 12, 5}},   // time(us): 208.48
    {{6912, 11, 5120}, {16, 11, 2, 8, 11}},  // time(us): 220.48
    {{6912, 12, 5120}, {16, 12, 2, 8, 12}},  // time(us): 224.48
    {{6912, 13, 5120}, {16, 13, 2, 16, 13}}, // time(us): 280.0
    {{6912, 14, 5120}, {12, 14, 4, 4, 7}},   // time(us): 264.32
    {{6912, 15, 5120}, {24, 15, 4, 12, 5}},  // time(us): 281.92
    {{6912, 16, 5120}, {24, 8, 4, 8, 4}},    // time(us): 260.8
    {{6912, 1, 5120}, {24, 1, 8, 24, 1}},    // time(us): 69.76
    {{6912, 2, 5120}, {8, 2, 32, 4, 2}},     // time(us): 76.48
    {{6912, 3, 5120}, {16, 3, 8, 8, 3}},     // time(us): 88.48
    {{6912, 4, 5120}, {12, 4, 8, 4, 4}},     // time(us): 96.8
    {{6912, 5, 5120}, {24, 5, 4, 12, 5}},    // time(us): 121.12
    {{6912, 6, 5120}, {16, 6, 4, 8, 6}},     // time(us): 129.28
    {{6912, 7, 5120}, {12, 7, 4, 4, 7}},     // time(us): 159.84
    {{6912, 8, 5120}, {12, 8, 8, 4, 4}},     // time(us): 153.12
    {{6912, 9, 5120}, {8, 9, 16, 4, 3}},     // time(us): 201.6
    {{896, 10, 4864}, {8, 5, 16, 4, 5}},     // time(us): 40.32
    {{896, 10, 896}, {8, 10, 16, 8, 5}},     // time(us): 16.16
    {{896, 11, 4864}, {8, 11, 16, 4, 11}},   // time(us): 50.72
    {{896, 11, 896}, {8, 11, 16, 4, 11}},    // time(us): 18.4
    {{896, 12, 4864}, {16, 4, 16, 8, 4}},    // time(us): 43.52
    {{896, 12, 896}, {8, 4, 16, 4, 4}},      // time(us): 17.12
    {{896, 13, 4864}, {4, 13, 8, 4, 13}},    // time(us): 56.96
    {{896, 13, 896}, {8, 13, 8, 8, 13}},     // time(us): 19.84
    {{896, 14, 4864}, {8, 7, 8, 8, 7}},      // time(us): 45.6
    {{896, 14, 896}, {16, 7, 8, 16, 7}},     // time(us): 17.92
    {{896, 15, 4864}, {4, 15, 8, 4, 15}},    // time(us): 52.8
    {{896, 15, 896}, {8, 15, 8, 8, 15}},     // time(us): 17.76
    {{896, 16, 4864}, {8, 8, 8, 8, 8}},      // time(us): 46.88
    {{896, 16, 896}, {8, 8, 8, 8, 8}},       // time(us): 17.6
    {{896, 1, 4864}, {4, 1, 64, 4, 1}},      // time(us): 20.96
    {{896, 1, 896}, {16, 1, 32, 16, 1}},     // time(us): 12.48
    {{896, 2, 4864}, {8, 2, 64, 8, 2}},      // time(us): 21.6
    {{896, 2, 896}, {8, 2, 32, 8, 2}},       // time(us): 12.64
    {{896, 3, 4864}, {4, 3, 32, 4, 3}},      // time(us): 25.12
    {{896, 3, 896}, {4, 3, 32, 4, 3}},       // time(us): 13.76
    {{896, 4, 4864}, {8, 4, 32, 8, 4}},      // time(us): 25.12
    {{896, 4, 896}, {16, 4, 16, 16, 4}},     // time(us): 13.12
    {{896, 5, 4864}, {8, 5, 32, 4, 5}},      // time(us): 28.64
    {{896, 5, 896}, {8, 5, 16, 8, 5}},       // time(us): 14.88
    {{896, 6, 4864}, {8, 6, 32, 4, 6}},      // time(us): 31.52
    {{896, 6, 896}, {8, 6, 32, 8, 2}},       // time(us): 14.4
    {{896, 7, 4864}, {4, 7, 16, 4, 7}},      // time(us): 37.76
    {{896, 7, 896}, {8, 7, 16, 8, 7}},       // time(us): 16.0
    {{896, 8, 4864}, {8, 4, 16, 8, 4}},      // time(us): 33.44
    {{896, 8, 896}, {8, 8, 16, 8, 8}},       // time(us): 14.56
    {{896, 9, 4864}, {8, 3, 16, 4, 3}},      // time(us): 41.6
    {{896, 9, 896}, {28, 3, 16, 14, 3}}      // time(us): 17.44
};

inline LookupValue size_lookup(int nrows_w, int nrows_x, int ncols)
{
    static const LookupValue defaultValue = {16, 16, 8, 16, 4};

    auto it = size_lookup_table.find({nrows_w, nrows_x, ncols});
    if (it != size_lookup_table.end())
    {
        return it->second;
    }
    else
    {
        return defaultValue;
    }
}